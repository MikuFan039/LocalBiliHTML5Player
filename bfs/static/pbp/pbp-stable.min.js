/*!
 * pbp | v3.5.0
 * 7/10/2020, 6:43:15 AM
 * wushiyang <wushiyang@bilibili.com>, lipengcheng <lipengcheng@bilibili.com>, tangjunxing <tangjunxing@bilibili.com>
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).BiliPBP=t()}(this,function(){"use strict";function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function i(e,t,i){return t&&a(e.prototype,t),i&&a(e,i),e}var n=function(){function e(){t(this,e),this.requestQueue=[]}return i(e,[{key:"getDatabase",value:function(e){var t=new r(e);return this.requestQueue.push(t),t}}]),e}(),r=function(){function e(i){var a=this;t(this,e),this._instance=window.indexedDB.open(i.service+i.version,1),this.onReady=i.onReady|{},this.onFirstCreate=i.onFirstCreate|{},this.isReady=!1,this._dbStore=null,this._instance.onerror=function(e){console.error("IDB error"+e)},this._instance.onsuccess=function(e){a._dbStore=a._instance.result,a.isReady=!0,i.onReady()},this._instance.onupgradeneeded=function(e){var t=e.target.result;t.objectStoreNames.contains("pbpZebraCache")||t.createObjectStore("pbpZebraCache",{keyPath:"cid"}),a._dbStore=t,i.onFirstCreate()}}return i(e,[{key:"get",value:function(a,n){var r=this;return new Promise(function(t,e){var i;r.isReady?((i=r._dbStore.transaction(["pbpZebraCache"]).objectStore("pbpZebraCache").get(a)).onerror=function(e){t(n,e)},i.onsuccess=function(e){i.result?t(i.result):t(n)}):e(new Error)})}},{key:"set",value:function(a,n){var r=this;return new Promise(function(t,i){var e;r.isReady?((e=r._dbStore.transaction(["pbpZebraCache"],"readwrite")).oncomplete=function(e){t(!0)},e.onerror=function(e){i(e)},a.expireTime=Date.parse(new Date)+n,e.objectStore("pbpZebraCache").put(a)):i(new Error)})}},{key:"checkExpire",value:function(t){var i=this;t?this.get(t,!1).then(function(e){e&&e.expireTime<Date.parse(new Date)&&(i._dbStore.transaction(["pbpZebraCache"],"readwrite").objectStore("pbpZebraCache").delete(t).onsuccess=function(e){})}):this._dbStore.transaction(["pbpZebraCache"],"readwrite").objectStore("pbpZebraCache").openCursor().onsuccess=function(e){var t=e.target.result;t&&(i.checkExpire(t.key),t.continue())}}}]),e}();n.getInstance=function(e){return window.indexedDbHelperV1||(window.indexedDbHelperV1=new n),window.indexedDbHelperV1.getDatabase(e)},n.clearWsCache=function(){Object.keys(localStorage).forEach(function(e){return-1!==e.indexOf("pbp_zebra")||-1!==e.indexOf("pbp_rec")?localStorage.removeItem(e):""})},n.isSupport=function(){return!!window.indexedDB};function l(e,t){var i=localStorage.getItem(e);return null==i&&s(e,t),i||t}var s=function(e,t){localStorage.setItem(e,t)},d="bilibili_pbp",c="bilibili_pbp_guide",b="bilibili_pbp_panel",u="bilibili_pbp_panel_style",h="bilibili-player-video-control",p="bilibili_pbp_pin",g=1e3,e="3.5.0",o={l:16,m:28,h:32},v={l:.5,m:.2,h:.1},w={b:{fillColor:"255,255,255",playedColor:"35,173,229"},p:{fillColor:"255,255,255",playedColor:"251,114,153"},r:{fillColor:"255,255,255",playedColor:"178,45,67"},g:{fillColor:"255,255,255",playedColor:"11,163,150"}};return function(){function a(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};t(this,a),this.options=e,this._clearStore(),this._status="wait",this._pbptag={},this._pbptagstr=""}return i(a,null,[{key:"isSupport",value:function(){return!!(window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver)&&(!!Promise&&(!(!localStorage&&!sessionStorage)&&!!n.isSupport()))}},{key:"loadLab",value:function(e){e&&("undefined"!=typeof window&&window.player&&window.player.loadLab?window.player.loadLab(1):setTimeout(function(){a.loadLab(--e)},500))}}]),i(a,[{key:"init",value:function(e,t){var c=this,i=0<arguments.length&&void 0!==e?e:"default",b=1<arguments.length&&void 0!==t?t:function(){};if("destroy"===this._status&&(this._status="wait"),!a.isSupport())return this._debugLog("init unsupported"),this.destroy(),b(new Error("environment not support"));this.eventKey=this.pbpDebugKey||i||"default",this._debugLog("init key =",this.eventKey),this._injectBiliPlayer().then(function(){return"destroy"===c._status?(c.destroy(),b(new Error("_status destroy"))):(c._debugLog("injectBiliPlayer complete"),c.aid&&c.cid?c.options&&c.options.data&&0<Object.keys(c.options.data).length?new Promise(function(e,t){e(c.options.data)}):new Promise(function(e,t){t(new Error("No Data."))}):b(new Error("aid || cid miss")))}).then(function(e){if("destroy"===c._status)return c.destroy(),b(new Error("_status destroy"));if(document.getElementById(d))return c.destroy(),b(new Error("old pbp not destroy"));if(c.video=document.querySelector("video"),!c.video)return c.destroy(),b(new Error("video element miss"));var t=e.step_sec,i=e.events,a=void 0===i?{}:i,n=e.tag,r=void 0===n?{}:n,o=e.tagstr,l=void 0===o?"":o,s=e.debug;c._pbptag=r,c._pbptagstr=l,c._debugLog("init api response debug: ",s);var p=a[c.eventKey];if(!p||!p.length||!t)return c.destroy(),c._debugLog("events[".concat(c.eventKey,"] length empty"),s),b(new Error("events[key] length empty"));c._debugLog("init async start: api.cidData complete",c.eventKey,p),c.st={name:c.eventKey,key:c.eventKey,points:c._calculatePercentage(p,t)},c._checkVersion(),c.options.panelDisabled||c._initPanel(c.eventKey,a),c._recoverZebraDataFromCache(b,c.st)}).catch(function(e){b?b(e):console.error(e),c._debugLog(e)})}},{key:"show",value:function(){var e,t,i;"destroy"!==this._status&&"show"!==this._status&&this.st&&(this._status="show",this._debugLog("call show"),e=l("pbp_height_v3","m"),t=o[e]?o[e]:o.m,i=window.player.getPlayerState().gamePlayer?"-33":"3",this.pbpStyle=document.createElement("style"),this.pbpStyle.innerHTML="#bilibili_pbp{display:flex;cursor:pointer;position:absolute;bottom:".concat(i,"px;left:-12px;width:calc(100% + 24px);height:").concat(t,"px;opacity:0;z-index:0}#bilibili_pbp.show{bottom:calc(100% - 2px);opacity:1;left:0;width:100%}.webfullscreen #bilibili_pbp,.mode-fullscreen #bilibili_pbp{bottom:5px}.webfullscreen #bilibili_pbp.show,.bilibili-player.mode-fullscreen #bilibili_pbp.show{bottom:calc(100% + 4px + 1px)}.bui-thumb{z-index:1}.bilibili-player-video-toast-wrp{z-index:1000}.bui-slider .bui-track.bui-track-video-progress{height:4px !important;border-radius:0}.bui-slider .bui-track .bui-bar-wrap{border-radius:0}.bilibili-player-video-state{z-index:998}.video-control-show .subtitle-position.subtitle-position-bc{bottom:74px}.mode-fullscreen .video-control-show .subtitle-position.subtitle-position-bc{bottom:84px}.mode-webfullscreen .video-control-show .subtitle-position.subtitle-position-bc{bottom:84px}#bilibili_pbp.pin{opacity:1}.video-control-show .bilibili-player-video-interactive{margin-bottom:16px}.webfullscreen .bilibili-player-video-interactive,.mode-fullscreen .bilibili-player-video-interactive{margin-bottom:24px}#bilibili_pbp_pin{cursor:pointer;position:absolute;bottom:calc(100%);z-index:1;color:white;opacity:0;line-height:16px;text-align:center}.bilibili-player .bilibili-player-area.video-control-show #bilibili_pbp_pin,.bilibili-player .bilibili-player-area .bilibili-player-video-control-wrap:hover #bilibili_pbp_pin{right:-8px;opacity:1}.webfullscreen #bilibili_pbp_pin,.mode-fullscreen #bilibili_pbp_pin{bottom:calc(100% + 4px + 1px + 2px)}#bilibili_pbp.pin{opacity:1}.pbp-icon{width:16px;height:16px;background-size:contain;transform:rotate(45deg)}.pbp-icon:hover{transform:rotate(60deg) scale(1.2);transition:all .1s ease-in-out;-webkit-transition:all .1s ease-in-out}.pbp-tips{position:absolute;font-size:12px;color:#fff;border-radius:4px;line-height:18px;padding:4px 8px;background-color:#000;background:rgba(0,0,0,.8);white-space:nowrap;right:0;top:0;display:none}#bilibili_pbp_pin:hover .pbp-tips{top:-30px;display:block;transition:all .3 ease-in-out;-webkit-transition:all .3 ease-in-out}"),document.head.appendChild(this.pbpStyle),this._updatePbpConfig(),this._create(),this._refresh(),this._observerChange(),this._initPin())}},{key:"hide",value:function(){if("destroy"!==this._status&&"hide"!==this._status&&(this._status="hide",this._debugLog("call hide"),this.pbp))try{var e=document.getElementsByClassName(h)[0];e.removeChild(this.pbp);var t=document.getElementById(c);this.video&&this.video.removeEventListener("seeking",this.videoSeekingCallback),window.player&&(window.player.removeEventListener("video_controlbar",this.videoControlbarCallback),window.player.removeEventListener("video_heartbeat",this.videoHeartbeatCallback),window.player.removeEventListener("video_progress_update",this.videoProgressUpdateCallback)),this.pbpStyle&&document.head.removeChild(this.pbpStyle),this.themeStyle&&(document.head.removeChild(this.themeStyle),this.themeStyle=null),t&&e.removeChild(t);var i=document.getElementById(p);i&&e.removeChild(i)}catch(e){console.log(e)}}},{key:"destroy",value:function(){"destroy"!==this._status&&(this._debugLog("call destroy"),this.hide(),this._clearStore(),this._status="destroy")}},{key:"_clearStore",value:function(){this.st=null,this.aid=null,this.cid=null,this.pbpStyle=null,this.themeStyle=null,this.pbp=null,this.video=null,this.player=null,this.pbpComponent=null,this.timeLine=null,this.zebraStart=0,this.zebraEnd=null,this.zebraAreas=[],this.lastUpdateTime=null,this.firstRefreshFlag=!1,this.videoHeartbeatFirstFlag=!1,this.eventKey=null,this.pbpDebugApi=localStorage.getItem("pbp_debug_api")||"",this.pbpDebugKey=localStorage.getItem("pbp_debug_key")||"",this.debug=!!this.options.debug||"1"===localStorage.getItem("pbp_debug")}},{key:"_checkVersion",value:function(){this._debugLog("pbp.js version: ".concat(e)),localStorage.getItem("pbp_version")!==e&&localStorage.setItem("pbp_version",e)}},{key:"_setThemeStyle",value:function(e){this.themeStyle&&"show"===this._status&&document.head.removeChild(this.themeStyle),"1"===localStorage.getItem("pbpstate")&&(this.themeStyle=document.createElement("style"),this.themeStyle.innerHTML=".bui-slider .bui-track.bui-track-video-progress .bui-bar-normal.bui-bar.bui-bar-normal { background: rgba(".concat(e,", 1); }"),document.head.appendChild(this.themeStyle))}},{key:"_updatePbpConfig",value:function(){var e=l("pbp_theme_v4","b"),e=w[e]?w[e]:w.b,t=l("pbp_opacity_v3","m"),t=v[t]?v[t]:v.m;this.st.opacity=t,this.st.fillColor="rgb(".concat(e.fillColor,")"),this.st.playedColor="rgb(".concat(e.playedColor,")"),this._setThemeStyle(e.playedColor)}},{key:"_setTheme",value:function(e){this._debugLog("call setTheme");var t=w[e]?w[e]:w.b;this.pbpComponent.fillRect.setAttribute("fill","rgb(".concat(t.fillColor,")")),this.pbpComponent.playedRect.setAttribute("fill","rgb(".concat(t.playedColor,")")),s("pbp_theme_v4",e),this._setThemeStyle(t.playedColor)}},{key:"_setHeight",value:function(e,t){e._debugLog("call setHeight");var i=o[t];e.pbp&&(e.pbp.style.height="".concat(i,"px")),s("pbp_height_v3",t)}},{key:"_setOpacity",value:function(e,t){e._debugLog("call setOpacity");var i=v[t];i&&(e.pbpComponent.group.setAttribute("fill-opacity",i),s("pbp_opacity_v3",t))}},{key:"_setPin",value:function(e,t){e._debugLog("call setPin"),e.pbp&&("1"===t?e.pbp.classList.add("pin"):e.pbp.classList.remove("pin")),s("pbp_pin_v3","1"===t?1:0)}},{key:"_initGuide",value:function(e){var t,i,a,n=localStorage.getItem("pbp_guide_closed"),r=document.getElementById(c);"1"===n||r||((t=document.createElement("style")).innerHTML="#bilibili_pbp_guide { opacity: 0; position: absolute; z-index: 2; height: 36px; line-height: 36px; bottom: calc(100% + 12px); left: -194%; display: block; align-items: center; padding: 2px; color: #fff; background: #00a1d6; white-space: nowrap; border-radius: 4px; box-shadow: 0 3px 6px 0 rgba(0,0,0,.2); font-size: 12px; } .webfullscreen #bilibili_pbp_guide, .mode-fullscreen #bilibili_pbp_guide { left: -113%; } .bilibili-player .bilibili-player-area.video-control-show #bilibili_pbp_guide, .bilibili-player .bilibili-player-area .bilibili-player-video-control-wrap:hover #bilibili_pbp_guide { opacity: 1; } #bilibili_pbp_guide:hover { background: #00b5e5; } #bilibili_pbp_guide:hover .pbp-guide-tri { border-top: 8px solid #00b5e5 } .pbp-guide-text { color: white; padding-right: 8px; padding-left: 8px; } .pbp-guide-tri { border-top: 8px solid #00a1d6; border-left: 8px solid transparent; border-right: 8px solid transparent; position: absolute; top: 100%; right: calc(50% - 8px); }",document.head.appendChild(t),(r=document.createElement("div")).setAttribute("id",c),(i=document.createElement("span")).setAttribute("class","pbp-guide-text"),i.innerText="新！《高能进度条》设置菜单",(a=document.createElement("span")).setAttribute("class","pbp-guide-tri"),r.appendChild(i),r.appendChild(a),e.appendChild(r),localStorage.setItem("pbp_guide_closed","1"))}},{key:"_initPanel",value:function(e,t){this._debugLog("call _initPanel");var i=document.getElementById(b),a=document.getElementById(u),n=document.getElementsByClassName("bilibili-player-video-control-bottom-right")[0];a||((a=document.createElement("style")).setAttribute("id",u),a.innerHTML="#bilibili_pbp_panel{position:relative}.pbp-panel-content-wrap{position:absolute;display:none;margin-left:-92px;bottom:41px}.webfullscreen .pbp-panel-content-wrap,.mode-fullscreen .pbp-panel-content-wrap{bottom:74px}.pbp-panel-content{cursor:auto;width:216px;background:rgba(21,21,21,.9);border-radius:2px;box-sizing:border-box;padding:12px 20px}.pbp-panel-icon-wrap{height:28px;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-transition:fill .3s;transition:fill .3s;vertical-align:middle;display:inline-block}.pbp-panel-icon{height:22px;width:22px}.webfullscreen .pbp-panel-icon,.mode-fullscreen .pbp-panel-icon{width:28px;height:28px}.pbp-panel-title{text-align:left;color:#fff;line-height:16px;font-size:12px}.pbp-panel-row{padding-bottom:8px}.pbp-panel-row:last-child{padding-bottom:0}.pbp-panel-row-content{display:flex;margin-top:4px}.pbp-panel-state-button{cursor:pointer;position:relative;border-radius:2px;color:#fff;text-align:center;margin-right:8px;background:hsla(0,0%,100%,.2);font-size:12px;flex:1;height:22px;line-height:22px}.pbp-panel-state-button:last-child{margin-right:0}.pbp-panel-state-button:hover{background:hsla(0,0%,100%,.4)}.pbp-panel-state-button.active{background:#00a1d6}.pbp-panel-state-button.active:hover{background:#00a1d6}.pbp-public-test-title{padding:1px 4px;display:inline-block;font-size:12px;-webkit-transform:scale(.7);transform:scale(.7);color:#fff;border-radius:4px;background:#f25d8e}.pbp-panel-description{color:white;font-size:12px;overflow:auto;white-space:normal}.pbp-panel-feedback{flex:1;font-size:12px;color:white;background:#f4598d;border-radius:4px;-webkit-transition:background-color .3s;transition:background-color .3s;height:22px;line-height:22px}.pbp-panel-feedback:hover{color:#fff;background-color:#ff85ad}.pbp-panel-qa{display:inline-block;background:gray;transform:scale(0.8);border-radius:50%;height:16px;width:16px;text-align:center;line-height:16px;margin-left:4px;position:relative}.pbp-panel-qa-tip{position:absolute;display:none;bottom:100%;padding:8px;border-radius:4px;left:100%;background-color:#fff;background:rgba(0,0,0,.8);white-space:nowrap}.pbp-panel-qa:hover .pbp-panel-qa-tip{display:block}.pbp-panel-theme-button{cursor:pointer;position:relative;border-radius:2px;color:#fff;margin-right:6px;flex:1;height:22px;border:1px solid rgba(0,0,0,.3)}.pbp-panel-theme-button:last-child{margin-right:0}.pbp-panel-theme-button.active{-webkit-box-shadow:0 0 1px 1px #fff;box-shadow:0 0 1px 1px #fff;border-color:#000}.pbp-panel-feedback-wrap{position:absolute;top:0;right:0;overflow:hidden;width:64px;height:64px}.pbp-panel-feedback-content{position:absolute;bottom:0;bottom:50%;left:50%;width:100%;height:100%;transform:rotate(45deg)}.pbp-panel-feedback-content-row{position:absolute;bottom:0;height:30%;width:100%;background:#f25d8e;box-shadow:0 2px 4px 0 rgba(0,0,0,.6)}.pbp-panel-feedback-link-wrap{height:100%;transform:scale(0.75)}.pbp-panel-feedback-link{font-size:12px;line-height:22px;color:white;display:block;text-align:center;width:100%}.pbp-panel-feedback-link:hover{color:white;text-decoration:underline}",document.head.appendChild(a)),i&&(n.removeChild(i),i=null),(i=document.createElement("div")).setAttribute("id",b),i.setAttribute("class","bilibili-player-video-btn");var r=document.createElement("span");r.setAttribute("class","bp-svgicon"),i.appendChild(r);var o=document.createElement("div");o.setAttribute("class","pbp-panel-content-wrap");var l=document.createElement("div");l.setAttribute("class","pbp-panel-content");function s(){p=0,setTimeout(function(){0===p&&o.setAttribute("style","display: none;")},80)}var p=0;i.addEventListener("mouseenter",function(){var e;p=1,o.setAttribute("style","display: block;"),"1"===localStorage.getItem("pbp_guide_closed")||(e=document.getElementById(c))&&(i.removeChild(e),localStorage.setItem("pbp_guide_closed",1))}),i.addEventListener("mouseleave",function(){s()}),o.addEventListener("mouseenter",function(){p=1}),o.addEventListener("mouseleave",function(){s()}),this._createPanelPbpRow(l,r),this._createPanelThemeRow(l),this._createPanelDescriptionRow(l),this._createPanelFeedbackRow(l),this.debug&&(this._createPanelHeightRow(l),this._createPanelOpacityRow(l),this._createPanelPinRow(l),this._createPanelDebugRow(l,e,t)),o.appendChild(l),i.appendChild(o),n.insertBefore(i,n.firstChild)}},{key:"_setPbpIcon",value:function(e,t){var i="1"===t?'<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 22 22"><path d="M15,19.05H7a5,5,0,0,1-5-5v-3.7a5,5,0,0,1,4.52-5l-1.3-1.2a1,1,0,0,1,0-1.42,1,1,0,0,1,1.41,0l2.71,2.5a.86.86,0,0,1,.13.14H12.6a1,1,0,0,1,.14-.15l2.7-2.5A1,1,0,1,1,16.8,4.17L15.49,5.38a5,5,0,0,1,4.51,5V12a.86.86,0,0,1,0,.16.91.91,0,0,1,0,.17v1.77A5,5,0,0,1,15,19.05ZM4,13.12v.93a3,3,0,0,0,3,3h8a3,3,0,0,0,3-3v-.93H14.36A.93.93,0,0,1,14,13a1.31,1.31,0,0,1-.31-.27l-.06-.1-.84-1.4-2.56,4.52A.88.88,0,0,1,10,16h0a1.08,1.08,0,0,1-.29.2,1.23,1.23,0,0,1-.42.07.89.89,0,0,1-.39-.09A1,1,0,0,1,8.59,16a1,1,0,0,1-.17-.25L7.13,13.12ZM8.65,11.7l.72,1.44,2.47-4.37A1.18,1.18,0,0,1,12,8.55a1,1,0,0,1,.29-.21,1,1,0,0,1,.41-.09.88.88,0,0,1,.41.08,1,1,0,0,1,.3.21.87.87,0,0,1,.17.21L15,11.13h3v-.77a3,3,0,0,0-3-3H7a3,3,0,0,0-3,3v.77H7.87a1.05,1.05,0,0,1,.71.44S8.63,11.65,8.65,11.7Z"/></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 22 22"><path d="M15,19.05H7a5,5,0,0,1-5-5v-3.7a5,5,0,0,1,4.52-5l-1.3-1.2a1,1,0,0,1,0-1.42,1,1,0,0,1,1.41,0l2.71,2.5a.86.86,0,0,1,.13.14H12.6a1,1,0,0,1,.14-.15l2.7-2.5A1,1,0,1,1,16.8,4.17L15.49,5.38a5,5,0,0,1,4.51,5V12a.86.86,0,0,1,0,.16.91.91,0,0,1,0,.17v1.77A5,5,0,0,1,15,19.05ZM4,13.12v.93a3,3,0,0,0,3,3h8a3,3,0,0,0,3-3v-.93ZM7,7.35a3,3,0,0,0-3,3v.77H18v-.76a3,3,0,0,0-3-3Z"/></svg>';e.innerHTML=i}},{key:"_createStateButtonGroup",value:function(a,n,e,r,o){for(var l,t=0;t<e.length;t++){var i=e[t];!function(e,t){var i=document.createElement("div");i.innerHTML=e,t===r?(i.setAttribute("class","pbp-panel-state-button active"),l=i):i.setAttribute("class","pbp-panel-state-button"),i.onclick=function(){l.classList.remove("active"),i.classList.add("active"),l=i,o(a,t)},n.appendChild(i)}(i.title,i.val)}}},{key:"_createPanelRow",value:function(e,t){var i,a=document.createElement("div");a.setAttribute("class","pbp-panel-row"),t&&((i=document.createElement("div")).innerHTML=t,i.setAttribute("class","pbp-panel-title"));var n=document.createElement("div");return n.setAttribute("class","pbp-panel-row-content"),i&&a.appendChild(i),a.appendChild(n),e.appendChild(a),n}},{key:"_createPanelFeedback",value:function(e){var t=document.createElement("div");t.setAttribute("class","pbp-panel-feedback-wrap");var i=document.createElement("div");i.setAttribute("class","pbp-panel-feedback-content");var a=document.createElement("div");a.setAttribute("class","pbp-panel-feedback-content-row");var n=document.createElement("div");n.setAttribute("class","pbp-panel-feedback-link-wrap");var r=document.createElement("a");r.setAttribute("class","pbp-panel-feedback-link"),r.setAttribute("href","https://www.bilibili.com/blackboard/activity-KMbzFht4z.html?from=panel"),r.setAttribute("target","_blank"),r.innerHTML="评价",n.appendChild(r),a.appendChild(n),i.appendChild(a),t.appendChild(i),e.appendChild(t)}},{key:"_createPanelPbpRow",value:function(e,n){var t=this._createPanelRow(e,"高能进度条"),r=0,o=0,i=localStorage.getItem("pbpstate");this._setPbpIcon(n,i);this._createStateButtonGroup(this,t,[{title:"开",val:"1"},{title:"关",val:"0"}],i,function(e,t){e._setPbpIcon(n,t),"1"===t?(localStorage.setItem("pbpstate",1),e.show()):(localStorage.setItem("pbpstate",0),e.hide());var i,a=(new Date).getTime();o=0===o||a-o<250?(r++,a):r=0,5===r&&(i=e.debug?"0":"1",s("pbp_debug",i),window.location.reload())})}},{key:"_createPanelDescriptionRow",value:function(e){var t=this._createPanelRow(e,null),i=document.createElement("div");i.setAttribute("class","pbp-panel-description"),i.innerHTML="代表多数用户拖动的位置或弹幕密集区，避免您错过精彩内容！",t.appendChild(i)}},{key:"_createPanelFeedbackRow",value:function(e){var t=this._createPanelRow(e,null),i=document.createElement("a");i.innerHTML="评价",i.setAttribute("class","pbp-panel-feedback"),i.setAttribute("target","_blank");i.setAttribute("href","https://www.bilibili.com/blackboard/activity-KMbzFht4z.html?from=panel&version=3.5.0"),t.appendChild(i)}},{key:"_createPanelHeightRow",value:function(e){var t=this._createPanelRow(e,"高度"),i=l("pbp_height_v3","m"),i=o[i]?i:"m";this._createStateButtonGroup(this,t,[{title:"低",val:"l"},{title:"中",val:"m"},{title:"高",val:"h"}],i,this._setHeight)}},{key:"_createPanelOpacityRow",value:function(e){var t=this._createPanelRow(e,"透明度"),i=l("pbp_opacity_v3","m"),i=v[i]?i:"m";this._createStateButtonGroup(this,t,[{title:"低",val:"l"},{title:"中",val:"m"},{title:"高",val:"h"}],i,this._setOpacity)}},{key:"_createPanelPinRow",value:function(e){var t=this._createPanelRow(e,'常驻模式<div class="pbp-panel-qa">?<div class="pbp-panel-qa-tip">当面板隐藏的时候保持高能进度条展示</div></div>'),i=l("pbp_pin_v3","0");this._createStateButtonGroup(this,t,[{title:"开",val:"1"},{title:"关",val:"0"}],i,this._setPin)}},{key:"_pinStateChange",value:function(e,t,i){var a=document.getElementById(d).classList;i?(this._setPin(this,"1"),e.innerHTML='<svg t="1571033023877" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3699" width="16" height="16"><path d="M726.646154 466.707692h-9.846154L649.846154 155.569231h17.723077c31.507692 0 57.107692-25.6 57.107692-57.107693s-25.6-57.107692-57.107692-57.107692H356.430769c-31.507692 0-57.107692 25.6-57.107692 57.107692s25.6 57.107692 57.107692 57.107693h17.723077l-64.984615 311.138461h-9.846154c-31.507692 0-57.107692 25.6-57.107692 57.107693s25.6 57.107692 57.107692 57.107692h165.415385v342.646154c0 31.507692 25.6 59.076923 59.076923 59.076923s59.076923-25.6 59.076923-59.076923V582.892308H728.615385c31.507692 0 57.107692-25.6 57.107692-57.107693s-27.569231-59.076923-59.076923-59.076923z" p-id="3700" fill="#ffffff"></path></svg>',t.innerText="关闭《高能进度条》常驻",a.add("pin")):(this._setPin(this,"0"),e.innerHTML='<svg t="1571033005936" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3385" width="16" height="16"><path d="M85.333333 224.853333 139.946667 170.666667 853.333333 884.053333 799.146667 938.666667 546.133333 685.653333 546.133333 938.666667 477.866667 938.666667 477.866667 682.666667 256 682.666667 256 597.333333 341.333333 512 341.333333 480.853333 85.333333 224.853333M682.666667 512 768 597.333333 768 682.666667 760.32 682.666667 341.333333 263.68 341.333333 170.666667 298.666667 170.666667 298.666667 85.333333 725.333333 85.333333 725.333333 170.666667 682.666667 170.666667 682.666667 512Z" p-id="3386" fill="#ffffff"></path></svg>',t.innerText="打开《高能进度条》常驻",a.remove("pin")),s("pbp_pin_v3",i?"1":"0")}},{key:"_initPin",value:function(){var i=this,e=document.getElementById(p),t=document.querySelector("."+h);(e=document.createElement("div")).setAttribute("id",p);var a=document.createElement("div");a.setAttribute("class","pbp-icon");var n=document.createElement("span");n.setAttribute("class","pbp-tips"),e.appendChild(a),e.appendChild(n);var r=this;t.appendChild(e);var o="1"===l("pbp_pin_v3","0");this._pinStateChange(a,n,o),e.addEventListener("click",function(e){var t="1"!==l("pbp_pin_v3","0");r._pinStateChange(a,n,t),window.pinClickCount||(window.pinClickCount=1),10<=window.pinClickCount&&(window.pinClickCount=1,s("pbp_debug",i.debug?"0":"1"),window.location.reload()),window.pinClickCount++})}},{key:"_createPanelThemeRow",value:function(e){function t(e){var t=document.createElement("div");t.style.backgroundColor="rgb(".concat(w[e].playedColor,")"),e===r?(t.setAttribute("class","pbp-panel-theme-button active"),i=t):t.setAttribute("class","pbp-panel-theme-button"),t.onclick=function(){i.classList.remove("active"),t.classList.add("active"),i=t,a._setTheme(e)},n.appendChild(t)}var i,a=this,n=this._createPanelRow(e,"主题"),r=l("pbp_theme_v4","b"),r=w[r]?r:"b";t("b"),t("p"),t("g"),t("r")}},{key:"_createPanelDebugRow",value:function(e,i,t){var a=this._createPanelRow(e,"Debug"),n=document.createElement("select");n.setAttribute("style","width: 100%; font-size: 12px; color: black;"),n.addEventListener("change",function(){var e=n.selectedIndex,t=n.options[e].getAttribute("value");localStorage.setItem("pbp_debug_key",t),window.location.reload()}),Object.keys(t).forEach(function(e){var t=new Option(e,e);e===i&&t.setAttribute("selected",""),n.add(t)}),a.appendChild(n)}},{key:"_saveZebraAreas",value:function(){if(null!==this.zebraStart&&null!==this.zebraEnd){for(var e=0;e<this.zebraAreas.length;e++){var t=this.zebraAreas[e][0],i=this.zebraAreas[e][1];if(this.zebraStart>i){if(e+1!==this.zebraAreas.length)continue;this.zebraAreas.push([this.zebraStart,this.zebraEnd]);break}if(this.zebraStart>=t&&this.zebraEnd<=i)break;this.zebraStart<=t&&this.zebraEnd>=t&&this.zebraEnd<i?this.zebraAreas[e]=[this.zebraStart,i]:this.zebraStart>=t&&this.zebraStart<=i&&this.zebraEnd>i?this.zebraAreas[e]=[t,this.zebraEnd]:this.zebraAreas.splice(e,0,[this.zebraStart,this.zebraEnd]);break}if(1<this.zebraAreas.length){for(var a=[],n=this.zebraAreas[0][1],r=0,o=1;o<this.zebraAreas.length;o++){var l=this.zebraAreas[o][0],s=this.zebraAreas[o][1];l<n?(n<s&&(this._debugLog("delete merge end"),this.zebraAreas[r]=[this.zebraAreas[r][0],s],n=s,r=o),this._debugLog("delete: ".concat(o,", ").concat(l,", ").concat(s)),a.push(o)):(n=s,r=o)}var p=this;a.forEach(function(e,t){p._debugLog("delete start: ".concat(e-t)),p.zebraAreas.splice(e-t,1)})}else this.zebraAreas.push([this.zebraStart,this.zebraEnd]);this._refreshZebraClipPath()}}},{key:"_recoverZebraDataFromCache",value:function(t,i){var a=this,e={service:"pbp",version:"3",onReady:function(){window.PbpIDBHelper.get(a.cid,null).then(function(e){if(e)try{a.zebraAreas=e.data}catch(e){a._debugLog("Zebra data parse error"+e)}finally{t(null,i),a._refreshZebraClipPath()}else t(null,i),a._refreshZebraClipPath(),window.PbpIDBHelper.checkExpire(null)}).catch(function(e){a._debugLog("WTF! unkowen"+JSON.stringify(e))})},onFirstCreate:function(){n.clearWsCache()}};window.PbpIDBHelper=n.getInstance(e)}},{key:"_cacheZebraData",value:function(){if(this.zebraAreas){this._debugLog("call _cacheZebraData");try{window.PbpIDBHelper.set({cid:this.cid,data:this.zebraAreas},2592e6)}catch(e){this._debugLog("Zebra data stringify or save error"+e)}}}},{key:"_generateBezierCurvePath",value:function(e,t,i){var a=.2*i,n=e[1].wPercentage*t/2,r=["M 0 100 L 0 ".concat(i-a)],o=0,l=i-a;e.push({wPercentage:1,hPercentage:0});for(var s=1;s<e.length;s++){var p=e[s],c=p.wPercentage*t,b=i-(a+.8*p.hPercentage*i),d=o+n;r.push("C ".concat(d.toFixed(1)," ").concat(l.toFixed(1),", ").concat(d.toFixed(1)," ").concat(b.toFixed(1),", ").concat(c.toFixed(1)," ").concat(b.toFixed(1))),o=c,l=b}r.push("L 1000 100 Z");var u=r.join(" ");return this._debugLog("call _generateBezierCurvePath: ".concat(u)),u}},{key:"_generateZebraPath",value:function(e,t){for(var i=[],a=0;a<e.length;a++){var n=e[a],r=t*n[0],o=t*n[1];i.push("M ".concat(r.toFixed(1)," 100 H ").concat(o.toFixed(1)," V 0 H ").concat(r.toFixed(1)," Z"))}var l=i.join(" ");return this._debugLog("call _generateZebraPath: ".concat(l)),l}},{key:"_create",value:function(){var e,i,t,a,n,r,o,l,s,p,c,b;this.st&&((e=document.getElementById(d))||((e=document.createElement("div")).setAttribute("id",d),(i=document.createElementNS("http://www.w3.org/2000/svg","svg")).setAttribute("viewBox","0 0 ".concat(g," ").concat(100)),i.setAttribute("preserveAspectRatio","none"),i.setAttribute("width","100%"),i.setAttribute("height","100%"),t=document.createElementNS("http://www.w3.org/2000/svg","defs"),(a=document.createElementNS("http://www.w3.org/2000/svg","clipPath")).setAttribute("id","pbp-curve-path"),a.setAttribute("clipPathUnits","userSpaceOnUse"),(n=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d",this._generateBezierCurvePath(this.st.points,g,100)),a.appendChild(n),(r=document.createElementNS("http://www.w3.org/2000/svg","clipPath")).setAttribute("id","pbp-played-path"),r.setAttribute("clipPathUnits","userSpaceOnUse"),(o=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("x","0"),o.setAttribute("width","0"),o.setAttribute("y","0"),o.setAttribute("height","100%"),r.appendChild(o),(l=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d",this._generateZebraPath(this.zebraAreas,g)),r.appendChild(l),t.appendChild(a),t.appendChild(r),(s=document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("fill-opacity",this.st.opacity),s.setAttribute("clip-path","url(#pbp-curve-path)"),s.setAttribute("class","bilibili-player-videoshot-area"),(p=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("x","0"),p.setAttribute("y","0"),p.setAttribute("width","100%"),p.setAttribute("height","100%"),p.setAttribute("fill",this.st.fillColor),s.appendChild(p),(c=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("x","0"),c.setAttribute("y","0"),c.setAttribute("width","100%"),c.setAttribute("height","100%"),c.setAttribute("fill",this.st.playedColor),c.setAttribute("clip-path","url(#pbp-played-path)"),s.appendChild(c),(b=document.createElementNS("http://www.w3.org/2000/svg","line")).setAttribute("y1","0"),b.setAttribute("y2","100%"),b.setAttribute("style","stroke: ".concat("rgba(255,255,255,0.2)","; stroke-width: 1;")),s.appendChild(b),i.appendChild(t),i.appendChild(s),e.appendChild(i),document.getElementsByClassName(h)[0].appendChild(e),window.player.getPlayerState()&&window.player.getPlayerState().controller.show?e.classList.add("show"):e.classList.remove("show"),s.addEventListener("click",function(e){var t=(e.clientX-i.getBoundingClientRect().left)/i.getBoundingClientRect().width;window.player.seek(t*window.player.getDuration()),window.player.track("slidepbp")}),this.pbp=e,this.pbpComponent={pbpSvg:i,group:s,currentRect:o,zebraPath:l,fillRect:p,playedRect:c,currentTimeLine:b}))}},{key:"_refresh",value:function(){var e,t,i;null!==this.zebraStart&&null!==this.zebraEnd&&this.zebraEnd>this.zebraStart&&(e=this.pbpComponent.currentRect,t=100*this.zebraStart,i=100*this.zebraEnd-t,e.setAttribute("x","".concat(t.toFixed(2),"%")),e.setAttribute("width","".concat(i.toFixed(2),"%")));var a=window.player.getCurrentTime();this.firstRefreshFlag||(a=0,this.firstRefreshFlag=!0);var n=0<=(n=a/window.player.getDuration()*g-.5)?n:0,r=this.pbpComponent.currentTimeLine;r.setAttribute("x1","".concat(n)),r.setAttribute("x2","".concat(n))}},{key:"_refreshZebraClipPath",value:function(){this.pbpComponent.zebraPath.setAttribute("d",this._generateZebraPath(this.zebraAreas,g))}},{key:"_observerChange",value:function(){var o=this;this._debugLog("observer change"),this.videoSeekingCallback=function(e){o._saveZebraAreas(),o.zebraStart=null,o.zebraEnd=null,o.lastUpdateTime=null},this.videoProgressUpdateCallback=function(e,t){var i=window.player.getDuration(),a=t.currentTime/i||0,n=a*i,r=!1;o.lastUpdateTime&&(r=n<o.lastUpdateTime||1.5<n-o.lastUpdateTime),r?(o._debugLog("invalid update, ignore."),o._saveZebraAreas(),o.zebraStart=null,o.zebraEnd=null,o.lastUpdateTime=null):(null===o.zebraStart&&(o.zebraStart=Number(a.toFixed(4))),o.zebraEnd=Number(a.toFixed(4)),o.lastUpdateTime=n),o._refresh()};var i=this.pbp.classList;this.videoControlbarCallback=function(e,t){t.show?i.add("show"):i.remove("show")},this.videoHeartbeatCallback=function(e,t){var i;o.videoHeartbeatFirstFlag?(i=window.player.getCurrentTime()/window.player.getDuration()||0,i=Number(i.toFixed(4)),o._debugLog("call video heartbeat: ".concat(i,", zebra time: ").concat(o.zebraStart," - ").concat(o.zebraEnd)),o.zebraEnd=i,o._saveZebraAreas(),o.zebraStart=o.zebraEnd,o.lastUpdateTime=null,o._cacheZebraData()):o.videoHeartbeatFirstFlag=!0},this.video.addEventListener("seeking",this.videoSeekingCallback),window.player.addEventListener("video_controlbar",this.videoControlbarCallback),window.player.addEventListener("video_heartbeat",this.videoHeartbeatCallback),window.player.addEventListener("video_progress_update",this.videoProgressUpdateCallback)}},{key:"_calculatePercentage",value:function(e,t){var i=window.player.getDuration(),a=Math.floor(i/t);this._debugLog("video_len:".concat(a," data_len:").concat(e.length)),a>e.length&&(e=e.concat(new Array(a-e.length).fill(0)));for(var n=e.length*t,r=e.reduce(function(e,t){return t<e?e:t},0),o=[],l=0;l<e.length;l++){var s=e[l],p=(p=s/r)||0;o.push({value:s,hPercentage:p,wPercentage:l*t/n})}return o}},{key:"_debugLog",value:function(){for(var e,t=arguments.length,i=new Array(t),a=0;a<t;a++)i[a]=arguments[a];this.debug&&(e=console).log.apply(e,["[PBP DEBUG]: "].concat(i))}},{key:"_injectBiliPlayer",value:function(){var n=this,r=10;return new Promise(function e(t,i){var a=document.querySelector(".".concat("bilibili-player-video-wrap"));if(window.BilibiliPlayer&&a)n.aid=+window.aid||window.bvid,n.cid=+window.cid,n.player=a,t();else{if(0===--r)return void i("miss BilibiliPlayer");setTimeout(function(){e(t,i)},500)}})}},{key:"stateStore",get:function(){var e={status:"disable",data:[],version:"3.5.0"};this.st&&this.st.points&&(e.data=this.st.points),e.data.length?"show"===this._status?e.status="enable":e.status="disable":e.status="enableFail";var t="1"===(t=l("pbp_pin_v3","0"))?t:"0",i=l("pbp_height_v3","m"),i=o[i]?i:"m",a=l("pbp_opacity_v3","m"),a=v[a]?a:"m",n=l("pbp_theme_v4","b"),n=w[n]?n:"b",r="1"===(r=l("pbp_debug","0"))?r:"0";return e.pbpstatus=e.status,e.pbptag=this._pbptag,e.pbptag.pbppin=Number(t),e.pbptag.pbpheight=i,e.pbptag.pbpopacity=a,e.pbptag.theme=n,e.pbptag.debug=r,e.pbptagstr=this._pbptagstr+"&pbppin_"+t+"&pbpheight_"+i+"&pbpopacity_"+a+"&pbptheme_"+n+"&pbpdebug_"+r,e}}]),a}()});